<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rating & Comment System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: linear-gradient(135deg, #ffffff, #000000);
      color: #fff;
      min-height: 100vh;
      padding-top: 30px;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-radius: 1rem;
      margin-bottom: 20px;
    }
    .star {
      font-size: 24px;
      cursor: pointer;
      color: gray;
      transition: color 0.2s;
    }
    .star:hover, .star.hover, .star.selected {
      color: gold;
    }
  </style>
</head>
<body class="container">

  <h1 class="text-center mb-4">üêæ Rating & Comment System</h1>

  <!-- Search -->
  <div class="input-group mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search topic...">
    <button class="btn btn-light" onclick="searchTopic()">Search</button>
  </div>

  <!-- Card Section -->
  <div id="cardContainer"></div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://kyqstizdkajrmhebxyip.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5cXN0aXpka2Fqcm1oZWJ4eWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNzcwMzcsImV4cCI6MjA3Nzc1MzAzN30.I2zP_uFsGn4Ib9Qb_Ux1mJ1kgWbeuX8_VRhF1m2GSC0'; // Paste your anon key here
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Topics (static for now)
    const topics = [
      { title: 'Cat', desc: 'The cat, also referred to as the domestic cat or house cat, is a small carnivorous mammal often kept as a pet.' },
      { title: 'Dog', desc: 'Dogs are domesticated mammals, not natural wild animals. They were originally bred from wolves.' },
      { title: 'Rabbit', desc: 'Rabbits are small, furry mammals with long ears, powerful hind legs, and a short fluffy tail.' }
    ];

    // Load cards
    async function loadCards(filter = '') {
      const container = document.getElementById('cardContainer');
      container.innerHTML = '';
      const filteredTopics = topics.filter(t => t.title.toLowerCase().includes(filter.toLowerCase()));

      for (const topic of filteredTopics) {
        const avg = await getAverageRating(topic.title);
        const comments = await getComments(topic.title);

        const card = document.createElement('div');
        card.className = 'card p-3 shadow';
        card.innerHTML = `
          <h3>${topic.title}</h3>
          <p>${topic.desc}</p>
          <p><strong>‚≠ê Average Rating:</strong> ${avg || 'No ratings yet'}</p>
          <div id="comments-${topic.title}" class="mb-3">
            <h5>üí¨ Comments & Ratings</h5>
            ${comments.length ? comments.map(c => `
              <p><strong>${c.name}</strong> ‚≠ê${c.rating}<br>${c.comment}</p>
            `).join('') : '<p>No comments yet.</p>'}
          </div>

          <input class="form-control mb-2" id="name-${topic.title}" placeholder="Your name">
          <textarea class="form-control mb-2" id="comment-${topic.title}" placeholder="Your comment"></textarea>

          <div id="rating-${topic.title}" class="mb-2">
            ${[1,2,3,4,5].map(i => `<span class="star" data-value="${i}">&#9733;</span>`).join('')}
          </div>

          <button class="btn btn-light" onclick="submitComment('${topic.title}')">Submit</button>
        `;
        container.appendChild(card);

        setupStarRating(topic.title);
      }
    }

    // Handle star ratings
    function setupStarRating(topic) {
      const stars = document.querySelectorAll(`#rating-${topic} .star`);
      stars.forEach(star => {
        star.addEventListener('mouseover', () => {
          stars.forEach(s => s.classList.remove('hover'));
          for (let i = 0; i < star.dataset.value; i++) stars[i].classList.add('hover');
        });
        star.addEventListener('mouseout', () => stars.forEach(s => s.classList.remove('hover')));
        star.addEventListener('click', () => {
          stars.forEach(s => s.classList.remove('selected'));
          for (let i = 0; i < star.dataset.value; i++) stars[i].classList.add('selected');
          document.getElementById(`rating-${topic}`).dataset.rating = star.dataset.value;
        });
      });
    }

    // Get comments
    async function getComments(topic) {
      const { data, error } = await supabase.from('comments').select('*').eq('topic', topic);
      return data || [];
    }

    // Get average rating
    async function getAverageRating(topic) {
      const { data, error } = await supabase.from('comments').select('rating').eq('topic', topic);
      if (!data || data.length === 0) return null;
      const avg = data.reduce((sum, c) => sum + c.rating, 0) / data.length;
      return avg.toFixed(1);
    }

    // Submit comment
    async function submitComment(topic) {
      const name = document.getElementById(`name-${topic}`).value.trim();
      const comment = document.getElementById(`comment-${topic}`).value.trim();
      const rating = parseInt(document.getElementById(`rating-${topic}`).dataset.rating || '0');

      if (!name || !comment || !rating) {
        alert('Please fill all fields and select a rating.');
        return;
      }

      const { error } = await supabase.from('comments').insert([{ topic, name, comment, rating }]);
      if (error) {
        alert('Error submitting comment!');
        console.error(error);
      } else {
        alert('Comment added!');
        loadCards(); // refresh
      }
    }

    // Search topics
    function searchTopic() {
      const query = document.getElementById('searchInput').value.trim();
      loadCards(query);
    }

    // Initial load
    loadCards();
  </script>
</body>
</html>

