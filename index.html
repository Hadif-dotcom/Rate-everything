<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wikipedia Rating & Comments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">üåê Wikipedia Rating & Comment Hub</h2>

    <!-- Search Bar -->
    <div class="input-group mb-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search a topic...">
      <button id="searchBtn" class="btn btn-primary">Search</button>
    </div>

    <!-- Wikipedia Card -->
    <div id="wikiCard" class="card shadow-sm mb-4 d-none">
      <div class="card-body">
        <h4 id="topicTitle"></h4>
        <p id="topicSummary"></p>
        <p><strong>‚≠ê Average Rating:</strong> <span id="averageRating">No ratings yet</span></p>
      </div>
    </div>

    <!-- Comments Section -->
    <div id="commentSection" class="card shadow-sm d-none">
      <div class="card-body">
        <h5>üí¨ Comments & Ratings</h5>
        <div id="commentsList" class="mb-3"></div>

        <div class="border-top pt-3">
          <input type="text" id="nameInput" class="form-control mb-2" placeholder="Your name">
          <textarea id="commentInput" class="form-control mb-2" rows="2" placeholder="Write a comment..."></textarea>
          <div class="mb-2">
            <label>Rating:</label>
            <select id="ratingInput" class="form-select w-auto d-inline-block">
              <option value="1">‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
            </select>
          </div>
          <button id="submitComment" class="btn btn-success">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üîó Your Supabase credentials
    const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const wikiCard = document.getElementById("wikiCard");
    const topicTitle = document.getElementById("topicTitle");
    const topicSummary = document.getElementById("topicSummary");
    const averageRating = document.getElementById("averageRating");
    const commentSection = document.getElementById("commentSection");
    const commentsList = document.getElementById("commentsList");
    const submitComment = document.getElementById("submitComment");

    let currentTopic = "";

    async function fetchWikipedia(topic) {
      const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
      if (!response.ok) {
        topicTitle.textContent = "Topic not found";
        topicSummary.textContent = "";
        return;
      }
      const data = await response.json();
      topicTitle.textContent = data.title;
      topicSummary.textContent = data.extract;
      wikiCard.classList.remove("d-none");
      commentSection.classList.remove("d-none");
      currentTopic = data.title;
      loadComments();
    }

    async function loadComments() {
      const { data, error } = await supabase
        .from("comments")
        .select("*")
        .eq("topic", currentTopic)
        .order("created_at", { ascending: true });

      if (error) {
        console.error(error);
        return;
      }

      commentsList.innerHTML = "";
      if (data.length === 0) {
        commentsList.innerHTML = "<p class='text-muted'>No comments yet.</p>";
        averageRating.textContent = "No ratings yet";
        return;
      }

      let total = 0;
      data.forEach(row => {
        total += row.rating;
        const div = document.createElement("div");
        div.classList.add("border", "rounded", "p-2", "mb-2");
        div.innerHTML = `<strong>${row.name || "Anonymous"}</strong> ‚≠ê${"‚≠ê".repeat(row.rating)}<br>${row.comment}`;
        commentsList.appendChild(div);
      });

      const avg = (total / data.length).toFixed(1);
      averageRating.textContent = `${avg} / 5 (${data.length} ratings)`;
    }

    async function submitCommentHandler() {
      const name = document.getElementById("nameInput").value.trim();
      const comment = document.getElementById("commentInput").value.trim();
      const rating = parseInt(document.getElementById("ratingInput").value);

      if (!comment) return alert("Please enter a comment before submitting.");

      const { error } = await supabase.from("comments").insert([
        { topic: currentTopic, name: name || "Anonymous", comment, rating }
      ]);

      if (error) {
        alert("Error saving comment: " + error.message);
        return;
      }

      document.getElementById("commentInput").value = "";
      loadComments();
    }

    searchBtn.addEventListener("click", () => {
      const topic = searchInput.value.trim();
      if (topic) fetchWikipedia(topic);
    });

    submitComment.addEventListener("click", submitCommentHandler);
  </script>
</body>
</html>
