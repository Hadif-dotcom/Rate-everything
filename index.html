<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rating & Comments Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #ffffff, #000000);
      color: white;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      margin-bottom: 1rem;
    }
    .star {
      cursor: pointer;
      font-size: 1.5rem;
      color: gold;
      transition: transform 0.2s;
    }
    .star:hover {
      transform: scale(1.3);
    }
    .active {
      color: gold;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="text-center mb-4">üê± Rating & Comments Demo</h1>

    <!-- Search Bar -->
    <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search topics...">

    <!-- Card Container -->
    <div id="cardContainer" class="row row-cols-1 row-cols-md-2 g-4"></div>

    <!-- Comment Section -->
    <div id="commentSection" class="mt-5">
      <h3 id="topicTitle"></h3>
      <div id="averageRating" class="mb-2"></div>
      <div id="comments"></div>

      <div class="mt-3">
        <input type="text" id="nameInput" class="form-control mb-2" placeholder="Your name">
        <textarea id="commentInput" class="form-control mb-2" placeholder="Your comment"></textarea>
        <div id="starRating" class="mb-2"></div>
        <button id="submitComment" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ===================== SUPABASE SETUP =====================
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://kyqstizdkajrmhebxyip.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5cXN0aXpka2Fqcm1oZWJ4eWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNzcwMzcsImV4cCI6MjA3Nzc1MzAzN30.I2zP_uFsGn4Ib9Qb_Ux1mJ1kgWbeuX8_VRhF1m2GSC0' // üîí Replace this with your anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // ===================== TOPICS =====================
    const topics = [
      { title: "Cat", desc: "The domestic cat is a small carnivorous mammal, loved for its companionship and hunting skills." },
      { title: "Dog", desc: "Dogs are loyal companions known for their intelligence, playfulness, and wide variety of breeds." },
      { title: "Bird", desc: "Birds are feathered vertebrates that lay eggs and are found in nearly every habitat on Earth." }
    ]

    // ===================== DISPLAY CARDS =====================
    const cardContainer = document.getElementById('cardContainer')
    const searchInput = document.getElementById('searchInput')

    function displayCards(filter = '') {
      cardContainer.innerHTML = ''
      topics
        .filter(t => t.title.toLowerCase().includes(filter.toLowerCase()))
        .forEach(t => {
          const col = document.createElement('div')
          col.className = 'col'
          col.innerHTML = `
            <div class="card p-3">
              <h4>${t.title}</h4>
              <p>${t.desc}</p>
              <button class="btn btn-outline-light viewBtn">View</button>
            </div>
          `
          col.querySelector('.viewBtn').addEventListener('click', () => openTopic(t.title))
          cardContainer.appendChild(col)
        })
    }

    searchInput.addEventListener('input', e => displayCards(e.target.value))
    displayCards()

    // ===================== COMMENTS + RATINGS =====================
    const topicTitle = document.getElementById('topicTitle')
    const commentSection = document.getElementById('commentSection')
    const commentsDiv = document.getElementById('comments')
    const nameInput = document.getElementById('nameInput')
    const commentInput = document.getElementById('commentInput')
    const starRating = document.getElementById('starRating')
    const submitComment = document.getElementById('submitComment')
    const averageRatingDiv = document.getElementById('averageRating')

    let currentTopic = null
    let selectedRating = 0

    // ====== Create interactive stars ======
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement('span')
      star.textContent = '‚òÖ'
      star.classList.add('star')
      star.addEventListener('mouseover', () => highlightStars(i))
      star.addEventListener('click', () => selectRating(i))
      starRating.appendChild(star)
    }

    function highlightStars(count) {
      document.querySelectorAll('.star').forEach((s, i) => {
        s.style.color = i < count ? 'gold' : 'gray'
      })
    }

    function selectRating(count) {
      selectedRating = count
      highlightStars(count)
    }

    // ====== Load Comments ======
    async function loadComments(topic) {
      const { data, error } = await supabase
        .from('comments')
        .select('*')
        .eq('topic', topic)
        .order('id', { ascending: true })

      if (error) console.error('Error loading:', error)
      displayComments(data || [])
    }

    function calculateAverage(comments) {
      if (comments.length === 0) return 0
      return (comments.reduce((sum, c) => sum + c.rating, 0) / comments.length).toFixed(1)
    }

    function displayComments(comments) {
      commentsDiv.innerHTML = ''
      if (comments.length === 0) {
        commentsDiv.innerHTML = '<p>No comments yet.</p>'
        averageRatingDiv.textContent = '‚≠ê Average Rating: No ratings yet'
        return
      }

      const avg = calculateAverage(comments)
      averageRatingDiv.textContent = `‚≠ê Average Rating: ${avg}`

      comments.forEach(c => {
        const div = document.createElement('div')
        div.classList.add('p-2', 'border', 'rounded', 'mb-2')
        div.innerHTML = `<strong>${c.name}</strong> (${c.rating}‚òÖ): ${c.comment}`
        commentsDiv.appendChild(div)
      })
    }

    // ====== Save Comment ======
    async function saveComment(topic, name, comment, rating) {
      const { error } = await supabase.from('comments').insert([{ topic, name, comment, rating }])
      if (error) console.error('Error saving:', error)
    }

    // ====== Handle Submit ======
    submitComment.addEventListener('click', async () => {
      const name = nameInput.value.trim()
      const comment = commentInput.value.trim()
      if (!name || !comment || selectedRating === 0) {
        alert('Please fill in all fields and select a rating!')
        return
      }

      await saveComment(currentTopic, name, comment, selectedRating)
      nameInput.value = ''
      commentInput.value = ''
      selectedRating = 0
      highlightStars(0)
      await loadComments(currentTopic)
    })

    // ====== Open Topic ======
    async function openTopic(topic) {
      currentTopic = topic
      topicTitle.textContent = topic
      await loadComments(topic)
      commentSection.scrollIntoView({ behavior: 'smooth' })
    }
  </script>
</body>
</html>


